@page "/dashboard"
@using JournalApp.Services
@using JournalApp.Data
@using JournalApp.Models

@* [VIVA INFO]: The Dashboard is the central 'Landing Hub' after login. 
   It provides a high-level overview (Recent Entries + Quick Stats).
*@
<PageTitle>Insights Overview - Reflecta</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8 mb-12">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-6 rounded-lg shadow-sm" ShowCloseIcon="true" CloseIconClicked="(() => errorMessage = string.Empty)">
            @errorMessage
        </MudAlert>
    }

    <div class="dashboard-hero animate-fade-in">
        <div class="hero-copy">
            <MudText Typo="Typo.h3" Class="fw-bold primary-gradient-text">Hello, @AuthState.GetCurrentUsername()</MudText>
            <MudText Typo="Typo.h6" Class="secondary-text mt-1 opacity-75">Your highlights and recent activity at a glance.</MudText>
            <div class="hero-meta">
                <span class="hero-chip">Entries: @(analytics?.TotalEntries ?? 0)</span>
                <span class="hero-chip">Momentum: @(analytics?.CurrentStreak ?? 0) days</span>
                <span class="hero-chip">Avg words: @((int)(analytics?.AverageWordCount ?? 0))</span>
            </div>
        </div>
        <div class="hero-actions">
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Rounded.EditNote" Size="Size.Medium" OnClick='(() => Navigation.NavigateTo("/create-entry"))' Class="new-entry-button">
                Write Reflection
            </MudButton>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-center align-center" style="height: 50vh;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" Thickness="5" />
        </div>
    }
    else
    {
        <!-- Insight Mosaic -->
        <MudGrid Class="mb-10">
            <MudItem xs="12" md="6">
                <div class="mosaic-card soft-rose">
                    <div class="mosaic-head">
                        <div class="mosaic-icon">üìò</div>
                        <MudText Typo="Typo.subtitle2" Class="mosaic-label">Journal Entries</MudText>
                    </div>
                    <MudText Typo="Typo.h3" Class="fw-extra-bold">@(analytics?.TotalEntries ?? 0)</MudText>
                    <MudText Typo="Typo.body2" Class="opacity-75">Your reflection archive is growing steadily.</MudText>
                </div>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <div class="mosaic-card soft-mint">
                    <div class="mosaic-head">
                        <div class="mosaic-icon">‚ö°</div>
                        <MudText Typo="Typo.subtitle2" Class="mosaic-label">Writing Momentum</MudText>
                    </div>
                    <MudText Typo="Typo.h3" Class="fw-extra-bold">@(analytics?.CurrentStreak ?? 0)</MudText>
                    <MudText Typo="Typo.body2" Class="opacity-75">You‚Äôre building a consistent habit.</MudText>
                </div>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <div class="mosaic-card soft-sand">
                    <div class="mosaic-head">
                        <div class="mosaic-icon">üèÜ</div>
                        <MudText Typo="Typo.subtitle2" Class="mosaic-label">Peak Consistency</MudText>
                    </div>
                    <MudText Typo="Typo.h3" Class="fw-extra-bold">@(analytics?.LongestStreak ?? 0)</MudText>
                    <MudText Typo="Typo.body2" Class="opacity-75">Your longest streak shows steady focus.</MudText>
                </div>
            </MudItem>
            <MudItem xs="12" md="6">
                <div class="mosaic-card soft-lilac">
                    <div class="mosaic-head">
                        <div class="mosaic-icon">üåô</div>
                        <MudText Typo="Typo.subtitle2" Class="mosaic-label">Days Paused</MudText>
                    </div>
                    <MudText Typo="Typo.h3" Class="fw-extra-bold">@(analytics?.MissedDays ?? 0)</MudText>
                    <MudText Typo="Typo.body2" Class="opacity-75">Rest days are part of a healthy rhythm.</MudText>
                </div>
            </MudItem>
        </MudGrid>

        <MudGrid>
            <!-- Recent Entries -->
            <MudItem xs="12" lg="8">
                <div class="d-flex align-center justify-space-between mb-4 px-2">
                    <MudText Typo="Typo.h5" Class="fw-bold">Recent Reflections</MudText>
                    @* <MudButton OnClick='(() => Navigation.NavigateTo("/entries"))' Variant="Variant.Text" Color="Color.Primary" EndIcon="@Icons.Material.Rounded.ArrowForward" Class="rounded-pill">Open Library</MudButton> *@
                </div>

                @if (recentEntries == null || !recentEntries.Any())
                {
                    <div class="empty-state-card mt-2">
                        <div class="empty-state-icon">
                            <MudIcon Icon="@Icons.Material.Rounded.AutoStories" />
                        </div>
                        <MudText Typo="Typo.h5" Class="fw-bold mt-4">No reflections yet</MudText>
                        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6 opacity-75">Start with a short note to begin your archive.</MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick='(() => Navigation.NavigateTo("/create-entry"))' Class="rounded-lg px-6">Write first reflection</MudButton>
                    </div>
                }
                else
                {
                    <MudStack Spacing="3" Class="mt-2 reflection-stream">
                        @foreach (var entry in recentEntries)
                        {
                            <div class="reflection-card" @onclick="(() => HandleEntryClick(entry))">
                                <div class="reflection-left">
                                    <div class="entry-mood-indicator @entry.PrimaryMoodCategory.ToString().ToLower()">
                                        @GetMoodEmoji(entry.PrimaryMood)
                                        @if (!string.IsNullOrEmpty(entry.Pin))
                                        {
                                            <div class="lock-overlay">
                                                <MudIcon Icon="@Icons.Material.Rounded.Lock" Size="Size.Small" Color="Color.Warning" />
                                            </div>
                                        }
                                    </div>
                                    <div class="date-badge">
                                        <span>@entry.EntryDate.ToString("MMM")</span>
                                        <strong>@entry.EntryDate.ToString("dd")</strong>
                                    </div>
                                </div>
                                <div class="entry-details py-1">
                                    <div class="d-flex align-center justify-space-between mb-1">
                                        <MudText Typo="Typo.h6" Class="fw-bold text-truncate">@entry.Title</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="fw-medium">@entry.EntryDate.ToString("yyyy")</MudText>
                                    </div>
                                    @if (string.IsNullOrEmpty(entry.Pin))
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-clamp opacity-75">@entry.Content</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Warning" Class="opacity-75 italic">Locked entry. Tap to unlock.</MudText>
                                    }
                                    <div class="d-flex align-center mt-3 gap-2">
                                        @if (!string.IsNullOrEmpty(entry.Tags))
                                        {
                                            @foreach (var tag in entry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries).Take(3))
                                            {
                                                <span class="modern-tag">#@tag.Trim()</span>
                                            }
                                        }
                                        <MudSpacer />
                                        <MudIcon Icon="@(string.IsNullOrEmpty(entry.Pin) ? Icons.Material.Rounded.ChevronRight : Icons.Material.Rounded.LockOpen)" Size="Size.Small" Color="Color.Secondary" />
                                    </div>
                                </div>
                            </div>
                        }
                    </MudStack>
                }
            </MudItem>

        </MudGrid>
    }
</MudContainer>

<style>
    .fw-extra-bold { font-weight: 900 !important; }
    .fw-bold { font-weight: 700 !important; }
    .uppercase-tracking { text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.75rem; font-weight: 800; }
    .opacity-75 { opacity: 0.75; }
    .secondary-text { color: var(--mud-palette-text-secondary); }
    .primary-text { color: var(--mud-palette-primary); }
    .secondary-text-alt { color: var(--mud-palette-secondary); }
    .tertiary-text { color: var(--mud-palette-tertiary); }
    .success-text { color: #6BBF9E; }

    .primary-gradient-text {
        background: var(--mud-palette-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .dashboard-hero {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        background: linear-gradient(135deg, rgba(255, 105, 180, 0.08), rgba(124, 200, 182, 0.08));
        border-radius: 24px;
        padding: 24px 28px;
        border: 1px solid rgba(var(--mud-palette-divider-rgb), 0.08);
        box-shadow: 0 18px 32px -24px rgba(0,0,0,0.3);
        margin-bottom: 28px;
    }
    .hero-copy { display: flex; flex-direction: column; gap: 8px; }
    .hero-actions { display: flex; align-items: center; }
    .hero-meta { display: flex; gap: 10px; flex-wrap: wrap; }
    .hero-chip {
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(255,255,255,0.7);
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--mud-palette-text-secondary);
        border: 1px solid rgba(var(--mud-palette-divider-rgb), 0.1);
    }

    .mosaic-card {
        padding: 1.5rem;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 150px;
        border: 1px solid rgba(255,255,255,0.6);
        box-shadow: 0 16px 30px -20px rgba(0,0,0,0.25);
    }
    .mosaic-head { display: flex; align-items: center; gap: 10px; }
    .mosaic-icon {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.7);
        font-size: 1.1rem;
    }
    .mosaic-label { letter-spacing: 0.05em; font-weight: 700; opacity: 0.75; }
    .soft-rose { background: linear-gradient(135deg, #FFE6F3 0%, #FFF2F8 100%); }
    .soft-mint { background: linear-gradient(135deg, #E8FBF5 0%, #F1FFFB 100%); }
    .soft-sand { background: linear-gradient(135deg, #FFEBD9 0%, #FFF4EA 100%); }
    .soft-lilac { background: linear-gradient(135deg, #EEF0FF 0%, #F7F8FF 100%); }

    .reflection-stream {
        padding-left: 6px;
    }
    .reflection-card {
        background: var(--mud-palette-surface);
        padding: 1.25rem;
        border-radius: 1.5rem;
        display: grid;
        grid-template-columns: 90px 1fr;
        gap: 1.25rem;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(var(--mud-palette-divider-rgb), 0.05);
        position: relative;
    }
    .reflection-card:hover {
        transform: translateY(-4px);
        border-color: rgba(var(--mud-palette-primary-rgb), 0.25);
        box-shadow: 0 12px 20px -10px rgba(0,0,0,0.15);
    }
    .reflection-left {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }
    .date-badge {
        width: 64px;
        border-radius: 16px;
        background: rgba(var(--mud-palette-primary-rgb), 0.08);
        color: var(--mud-palette-primary);
        padding: 8px 0;
        text-align: center;
        font-weight: 700;
        display: flex;
        flex-direction: column;
        line-height: 1.1;
        font-size: 0.8rem;
    }
    .date-badge strong { font-size: 1.1rem; }

    .stat-card.glass {
        padding: 1.9rem 2rem;
        border-radius: 1rem;
        clip-path: polygon(12px 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%, 0 12px);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--mud-palette-surface);
        border: 1px solid rgba(var(--mud-palette-divider-rgb), 0.08);
        min-height: 120px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .stat-card.glass:hover {
        transform: translateY(-6px);
        box-shadow: 0 14px 24px -10px rgba(0,0,0,0.12);
        border-color: rgba(var(--mud-palette-primary-rgb), 0.45);
        outline: 1px solid rgba(var(--mud-palette-secondary-rgb), 0.35);
    }


    .stat-card-entries {
        background: linear-gradient(135deg, #F3EEFF 0%, #E9F3FF 100%);
        border-color: rgba(var(--mud-palette-primary-rgb), 0.15);
    }
    .stat-card-streak {
        background: linear-gradient(135deg, #EAF9F4 0%, #F2F9F7 100%);
        border-color: rgba(var(--mud-palette-secondary-rgb), 0.15);
    }
    .stat-card-longest {
        background: linear-gradient(135deg, #FFF1EA 0%, #FFF7ED 100%);
        border-color: rgba(var(--mud-palette-tertiary-rgb), 0.15);
    }
    .stat-card-missed {
        background: linear-gradient(135deg, #F6F1EC 0%, #FFF8F2 100%);
        border-color: rgba(var(--mud-palette-divider-rgb), 0.2);
    }
    .stat-card-entries .mud-typography,
    .stat-card-streak .mud-typography,
    .stat-card-longest .mud-typography,
    .stat-card-missed .mud-typography {
        color: #2A2F33 !important;
    }

    [data-theme="Dark"] .stat-card-entries .mud-typography,
    [data-theme="Dark"] .stat-card-streak .mud-typography,
    [data-theme="Dark"] .stat-card-longest .mud-typography,
    [data-theme="Dark"] .stat-card-missed .mud-typography {
        color: #F5F0E9 !important;
    }

    .stat-icon-wrapper {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .primary-fade { background: rgba(var(--mud-palette-primary-rgb), 0.1); }
    .secondary-fade { background: rgba(var(--mud-palette-secondary-rgb), 0.1); }
    .tertiary-fade { background: rgba(var(--mud-palette-tertiary-rgb), 0.1); }
    .success-fade { background: rgba(16, 185, 129, 0.1); }

    .premium-entry-card {
        background: var(--mud-palette-surface);
        padding: 1.25rem;
        border-radius: 1.25rem;
        display: flex;
        gap: 1.25rem;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(var(--mud-palette-divider-rgb), 0.05);
    }
    .premium-entry-card:hover {
        transform: scale(1.01);
        border-color: rgba(var(--mud-palette-primary-rgb), 0.3);
        box-shadow: 0 8px 16px -4px rgba(0,0,0,0.05);
    }

    .entry-mood-indicator {
        position: relative;
        width: 54px;
        height: 54px;
        border-radius: 14px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        background: rgba(var(--mud-palette-surface-rgb), 0.05);
    }
    .lock-overlay {
        position: absolute;
        bottom: -4px;
        right: -4px;
        background: #1E2633;
        border: 2px solid #E9B86F;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .entry-mood-indicator.positive { background: rgba(16, 185, 129, 0.08); }
    .entry-mood-indicator.neutral { background: rgba(59, 130, 246, 0.08); }
    .entry-mood-indicator.negative { background: rgba(239, 68, 68, 0.08); }

    .modern-tag {
        background: rgba(var(--mud-palette-primary-rgb), 0.05);
        color: var(--mud-palette-primary);
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 700;
    }

    .insight-card {
        padding: 1.5rem;
        border-radius: 1.25rem;
        background: var(--mud-palette-surface);
        border: 1px solid rgba(var(--mud-palette-divider-rgb), 0.05);
    }
    .insight-card.info-gradient {
        background: linear-gradient(135deg, rgba(var(--mud-palette-primary-rgb), 0.03) 0%, rgba(var(--mud-palette-secondary-rgb), 0.03) 100%);
    }

    .goal-progress-wrapper { position: relative; display: flex; justify-content: center; }
    .goal-count {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .animate-fade-in {
        animation: fade-in 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    @@keyframes fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .text-clamp {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

@code {
    private string GetMoodEmoji(string mood)
    {
        return mood?.ToLower() switch
        {
            "happy" or "positive" or "joyful" or "excited" or "thrilled" => "üòä",
            "neutral" or "calm" or "tired" or "okay" or "peaceful" => "üòê",
            "sad" or "negative" or "angry" or "stressed" or "frustrated" => "üòî",
            _ => "üìù"
        };
    }
}
